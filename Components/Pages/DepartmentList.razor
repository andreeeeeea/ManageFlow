@page "/departments"
@using ManageFlow.Data.Models
@using ManageFlow.Services
@using ManageFlow.Components.Forms
@using ManageFlow.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@inject IDepartmentService DepartmentService
@inject UserManager<ApplicationUser> UserManager
@rendermode InteractiveServer

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="page-title mb-1">üè¢ Departments</h2>
            <p class="text-muted mb-0">Manage your organization's departments</p>
        </div>
    </div>
</div>

<div class="d-flex flex-column flex-lg-row gap-3 mb-4 align-items-lg-center">
    <div class="position-relative flex-grow-1">
        <i class="bi bi-search position-absolute search-icon"></i>
        <input
            type="text"
            class="form-control search-input"
            placeholder="Search departments..."
            @bind="searchTerm"
            @bind:event="oninput" />
    </div>
    @if (isManager)
    {
        <button class="btn btn-dark d-flex align-items-center gap-2 px-4 py-2 shadow" @onclick="ShowAddDepartmentForm">
            <i class="bi bi-plus-lg"></i>
            Add Department
        </button>
    }
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success" role="alert">
        @successMessage
    </div>
}

@if (showAddDepartmentForm)
{
    <AddDepartmentForm OnClose="@HandleAddFormClose" />
}

@if (showEditDepartmentForm)
{
    <EditDepartmentForm DepartmentId="@editingDepartmentId" OnClose="@HandleEditFormClose" />
}

@if (departments == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading departments...</p>
    </div>
}
else if (!FilteredDepartments.Any())
{
    <div class="empty-state text-center py-5">
        <i class="bi bi-building display-1 text-muted" style="opacity: 0.3;"></i>
        <h4 class="mt-3">No departments found</h4>
        <p class="text-muted">@(string.IsNullOrEmpty(searchTerm) ? "Start by adding your first department" : "Try a different search term")</p>
    </div>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var department in FilteredDepartments)
        {
            <div class="col">
                <div class="card h-100 department-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-building me-2"></i>@department.Name
                        </h5>
                        @if (isManager)
                        {
                            <div class="dropdown-container">
                                <button class="btn btn-sm btn-outline-secondary" type="button" @onclick="() => ToggleDropdown(department.Id)" @onclick:stopPropagation="true">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                @if (openDropdownId == department.Id)
                                {
                                    <div class="dropdown-menu-custom show">
                                        <button class="dropdown-item-custom" @onclick="() => ShowEditDepartmentForm(department.Id)">
                                            <i class="bi bi-pencil me-2"></i>Edit
                                        </button>
                                        <hr class="dropdown-divider-custom">
                                        <button class="dropdown-item-custom text-danger" @onclick="() => DeleteDepartment(department.Id)">
                                            <i class="bi bi-trash me-2"></i>Delete
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">
                            @(string.IsNullOrEmpty(department.Description) ? "No description provided" : department.Description)
                        </p>

                        <div class="department-stats">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-label">Department Head</span>
                                    <span class="stat-value">
                                        @if (department.Manager != null)
                                        {
                                            @($"{department.Manager.FirstName} {department.Manager.LastName}")
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not assigned</span>
                                        }
                                    </span>
                                </div>
                            </div>

                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-label">Employees</span>
                                    <span class="stat-value">@(departmentEmployeeCounts.GetValueOrDefault(department.Id, 0))</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .search-icon {
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 1rem;
    }

    .search-input {
        padding-left: 2.75rem;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 0.5rem;
        font-size: 1rem;
    }

    .search-input:focus {
        border-color: #64748b;
        box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.15);
    }

    .department-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .department-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .department-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .department-card .card-title {
        font-weight: 600;
        color: #333;
    }

    .department-stats {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background-color: #e7f1ff;
        color: #0d6efd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-weight: 600;
        color: #333;
    }

    .dropdown-container {
        position: relative;
    }

    .dropdown-menu-custom {
        position: absolute;
        right: 0;
        top: 100%;
        z-index: 1000;
        min-width: 140px;
        padding: 0.5rem 0;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-top: 0.25rem;
    }

    .dropdown-item-custom {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0.5rem 1rem;
        border: none;
        background: none;
        font-size: 0.875rem;
        color: #334155;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }

    .dropdown-item-custom:hover {
        background-color: #f1f5f9;
    }

    .dropdown-item-custom.text-danger {
        color: #dc2626;
    }

    .dropdown-item-custom.text-danger:hover {
        background-color: #fef2f2;
    }

    .dropdown-divider-custom {
        margin: 0.25rem 0;
        border: none;
        border-top: 1px solid #e2e8f0;
    }
</style>

@code {
    private List<Departments>? departments;
    private Dictionary<int, int> departmentEmployeeCounts = new();
    private string searchTerm = "";
    private string? errorMessage;
    private string? successMessage;
    private int editingDepartmentId;
    private int? openDropdownId;
    private bool showAddDepartmentForm = false;
    private bool showEditDepartmentForm = false;
    private bool isManager = false;

    private IEnumerable<Departments> FilteredDepartments =>
        departments?.Where(d =>
            string.IsNullOrEmpty(searchTerm) ||
            d.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            (d.Description?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (d.Manager != null && ($"{d.Manager.FirstName} {d.Manager.LastName}").Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
        ) ?? Enumerable.Empty<Departments>();

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (authenticationState != null)
            {
                var authState = await authenticationState;
                var user = await UserManager.GetUserAsync(authState.User);
                if (user != null)
                {
                    isManager = await UserManager.IsInRoleAsync(user, "Manager")
                             || await UserManager.IsInRoleAsync(user, "Admin");
                }
            }

            await LoadDepartments();
        }
        catch (Exception e)
        {
            errorMessage = e.Message;
            Console.WriteLine($"Error loading departments: {e.Message}");
        }
    }

    private async Task LoadDepartments()
    {
        departments = await DepartmentService.GetDepartmentsAsync();

        departmentEmployeeCounts.Clear();
        foreach (var dept in departments)
        {
            var employees = await DepartmentService.GetDepartmentEmployeesAsync(dept.Id);
            departmentEmployeeCounts[dept.Id] = employees.Count;
        }
    }

    private async Task DeleteDepartment(int departmentId)
    {
        CloseDropdown();
        try
        {
            await DepartmentService.DeleteDepartmentAsync(departmentId);
            await LoadDepartments();
            StateHasChanged();
            successMessage = "Department deleted successfully!";
        }
        catch (Exception e)
        {
            errorMessage = e.Message;
            Console.WriteLine($"Error deleting department: {e.Message}");
        }
    }

    private void ToggleDropdown(int departmentId)
    {
        openDropdownId = openDropdownId == departmentId ? null : departmentId;
    }

    private void CloseDropdown()
    {
        openDropdownId = null;
    }

    private void ShowAddDepartmentForm()
    {
        CloseDropdown();
        showAddDepartmentForm = true;
        StateHasChanged();
    }

    private void ShowEditDepartmentForm(int departmentId)
    {
        CloseDropdown();
        editingDepartmentId = departmentId;
        showEditDepartmentForm = true;
        StateHasChanged();
    }

    private async Task HandleAddFormClose()
    {
        showAddDepartmentForm = false;
        await LoadDepartments();
        StateHasChanged();
    }

    private async Task HandleEditFormClose()
    {
        showEditDepartmentForm = false;
        await LoadDepartments();
        StateHasChanged();
    }
}
