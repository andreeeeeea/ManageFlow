@page "/departments"
@using ManageFlow.Data.Models
@using ManageFlow.Services
@using ManageFlow.Components.Forms
@using ManageFlow.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@inject IDepartmentService DepartmentService
@inject UserManager<ApplicationUser> UserManager
@rendermode InteractiveServer

<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="page-title">üè¢ Departments</h2>
            <p class="text-muted">Manage your organization's departments</p>
        </div>
        @if (isManager)
        {
            <button class="btn btn-primary" @onclick="ShowAddDepartmentForm">
                <i class="bi bi-plus-circle"></i> Add New Department
            </button>
        }
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success" role="alert">
        @successMessage
    </div>
}

@if (showAddDepartmentForm)
{
    <AddDepartmentForm OnClose="@HandleAddFormClose" />
}

@if (showEditDepartmentForm)
{
    <EditDepartmentForm DepartmentId="@editingDepartmentId" OnClose="@HandleEditFormClose" />
}

@if (departments == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading departments...</p>
    </div>
}
else if (!departments.Any())
{
    <div class="empty-state text-center py-5">
        <h4>No departments found</h4>
        <p class="text-muted">Start by adding your first department</p>
    </div>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var department in departments)
        {
            <div class="col">
                <div class="card h-100 department-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-building me-2"></i>@department.Name
                        </h5>
                        @if (isManager)
                        {
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <button class="dropdown-item" @onclick="() => ShowEditDepartmentForm(department.Id)">
                                            <i class="bi bi-pencil me-2"></i>Edit
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <button class="dropdown-item text-danger" @onclick="() => DeleteDepartment(department.Id)">
                                            <i class="bi bi-trash me-2"></i>Delete
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">
                            @(string.IsNullOrEmpty(department.Description) ? "No description provided" : department.Description)
                        </p>

                        <div class="department-stats">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-label">Department Head</span>
                                    <span class="stat-value">
                                        @if (department.Manager != null)
                                        {
                                            @($"{department.Manager.FirstName} {department.Manager.LastName}")
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not assigned</span>
                                        }
                                    </span>
                                </div>
                            </div>

                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-label">Employees</span>
                                    <span class="stat-value">@(departmentEmployeeCounts.GetValueOrDefault(department.Id, 0))</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .department-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .department-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .department-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .department-card .card-title {
        font-weight: 600;
        color: #333;
    }

    .department-stats {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background-color: #e7f1ff;
        color: #0d6efd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-weight: 600;
        color: #333;
    }

    .dropdown-item {
        cursor: pointer;
    }
</style>

@code {
    private List<Departments>? departments;
    private Dictionary<int, int> departmentEmployeeCounts = new();
    private string? errorMessage;
    private string? successMessage;
    private int editingDepartmentId;
    private bool showAddDepartmentForm = false;
    private bool showEditDepartmentForm = false;
    private bool isManager = false;

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (authenticationState != null)
            {
                var authState = await authenticationState;
                var user = await UserManager.GetUserAsync(authState.User);
                if (user != null)
                {
                    isManager = await UserManager.IsInRoleAsync(user, "Manager")
                             || await UserManager.IsInRoleAsync(user, "Admin");
                }
            }

            await LoadDepartments();
        }
        catch (Exception e)
        {
            errorMessage = e.Message;
            Console.WriteLine($"Error loading departments: {e.Message}");
        }
    }

    private async Task LoadDepartments()
    {
        departments = await DepartmentService.GetDepartmentsAsync();

        departmentEmployeeCounts.Clear();
        foreach (var dept in departments)
        {
            var employees = await DepartmentService.GetDepartmentEmployeesAsync(dept.Id);
            departmentEmployeeCounts[dept.Id] = employees.Count;
        }
    }

    private async Task DeleteDepartment(int departmentId)
    {
        try
        {
            await DepartmentService.DeleteDepartmentAsync(departmentId);
            await LoadDepartments();
            StateHasChanged();
            successMessage = "Department deleted successfully!";
        }
        catch (Exception e)
        {
            errorMessage = e.Message;
            Console.WriteLine($"Error deleting department: {e.Message}");
        }
    }

    private void ShowAddDepartmentForm()
    {
        showAddDepartmentForm = true;
        StateHasChanged();
    }

    private void ShowEditDepartmentForm(int departmentId)
    {
        editingDepartmentId = departmentId;
        showEditDepartmentForm = true;
        StateHasChanged();
    }

    private async Task HandleAddFormClose()
    {
        showAddDepartmentForm = false;
        await LoadDepartments();
        StateHasChanged();
    }

    private async Task HandleEditFormClose()
    {
        showEditDepartmentForm = false;
        await LoadDepartments();
        StateHasChanged();
    }
}
