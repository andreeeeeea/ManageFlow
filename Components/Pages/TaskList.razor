@page "/tasks"
@using ManageFlow.Data.Models
@using ManageFlow.Services
@using ManageFlow.Components.Forms
@using ManageFlow.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@inject ITaskManagerService TaskService
@inject IEmployeeService EmployeeService
@inject IJSRuntime JS
@inject UserManager<ApplicationUser> UserManager
@rendermode InteractiveServer

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="page-title mb-1"><i class="bi bi-list-check me-2"></i>Task Management</h2>
            <p class="text-muted mb-0">Track and manage all your tasks in one place</p>
        </div>
        @if (isManager)
        {
            <button class="btn btn-dark d-flex align-items-center gap-2 px-4 py-2 shadow" @onclick="ShowAddTaskForm">
                <i class="bi bi-plus-lg"></i>
                Add Task
            </button>
        }
    </div>
</div>

<div class="d-flex flex-column flex-lg-row gap-3 mb-4 align-items-lg-center">
    <div class="position-relative flex-grow-1">
        <i class="bi bi-search position-absolute search-icon"></i>
        <input
            type="text"
            class="form-control search-input"
            placeholder="Search tasks..."
            @bind="searchTerm"
            @bind:event="oninput" />
    </div>

    <div class="filter-tabs">
        <button class="filter-tab @(statusFilter == null ? "active" : "")" @onclick="() => SetStatusFilter(null)">
            All
        </button>
        @foreach (var status in Enum.GetValues<WorkStatus>())
        {
            <button class="filter-tab @(statusFilter == status ? "active" : "")" @onclick="() => SetStatusFilter(status)">
                @FormatEnumName(status.ToString())
            </button>
        }
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success" role="alert">
        @successMessage
    </div>
}

@if (showAddTaskForm)
{
    <AddTaskForm OnClose="@HandleAddFormClose" />
}

@if (showEditTaskForm)
{
    <EditTaskForm TaskId="@selectedTaskId" OnClose="@HandleEditFormClose" />
}

@if (tasks == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading tasks...</p>
    </div>
}
else if (!FilteredTasks.Any())
{
    <div class="empty-state text-center py-5">
        <i class="bi bi-list-check display-1 text-muted"></i>
        <h4 class="mt-3">No tasks found</h4>
        <p class="text-muted">@(string.IsNullOrEmpty(searchTerm) ? "Start by creating your first task" : "Try a different search term")</p>
    </div>
}
else
{
    <div class="task-grid">
        @foreach (var task in FilteredTasks)
        {
            <div class="task-card">
                <div class="d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="task-title mb-0">@task.Title</h5>
                        @if (isManager)
                        {
                            <div class="d-flex gap-1">
                                <button class="btn btn-icon" @onclick="() => ShowEditTaskForm(task.Id)" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-icon btn-icon-danger" @onclick="() => DeleteTask(task.Id)" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        }
                    </div>

                    <p class="task-description">@(string.IsNullOrEmpty(task.Description) ? "No description" : task.Description)</p>

                    <div class="task-details">
                        <div class="detail-item">
                            <i class="bi bi-calendar-event"></i>
                            <span>@(task.Deadline?.ToShortDateString() ?? "No deadline")</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-people"></i>
                            <span>
                                @if (taskAssignments.ContainsKey(task.Id) && taskAssignments[task.Id].Any())
                                {
                                    @string.Join(", ", taskAssignments[task.Id].Select(e => $"{e.FirstName} {e.LastName}"))
                                }
                                else
                                {
                                    <span class="text-muted">Unassigned</span>
                                }
                            </span>
                        </div>
                    </div>

                    <div class="mt-auto pt-3 d-flex gap-2 flex-wrap">
                        <span class="status-badge @GetStatusClass(task.Status)">
                            @FormatEnumName(task.Status.ToString()).ToUpper()
                        </span>
                        <span class="priority-badge @GetPriorityClass(task.Priority)">
                            @task.Priority.ToString().ToUpper()
                        </span>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .search-icon {
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1rem;
    }

    .search-input {
        padding-left: 2.75rem;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        border: 1px solid var(--input-border);
        border-radius: 0.5rem;
        font-size: 1rem;
        background-color: var(--input-bg);
        color: var(--text-primary);
    }

    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .filter-tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
    }

    .filter-tab {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .filter-tab:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .filter-tab.active {
        background: #1e293b;
        color: white;
    }

    .task-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .task-card {
        background: var(--bg-secondary);
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.2s ease;
    }

    .task-card:hover {
        box-shadow: var(--card-shadow);
    }

    .task-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .task-description {
        font-size: 0.95rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .task-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .detail-item i {
        font-size: 0.875rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.875rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    .status-not-started {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
    }

    .status-just-started {
        background: #78350f;
        color: #fef3c7;
    }

    .status-in-progress {
        background: #1e40af;
        color: #dbeafe;
    }

    .status-completed {
        background: #166534;
        color: #dcfce7;
    }

    .status-on-hold {
        background: #7c3aed;
        color: #ede9fe;
    }

    .status-cancelled {
        background: #6b7280;
        color: #f3f4f6;
    }

    .priority-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.875rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    .priority-low {
        background: #6b7280;
        color: #f3f4f6;
    }

    .priority-medium {
        background: #2563eb;
        color: #dbeafe;
    }

    .priority-high {
        background: #ea580c;
        color: #fff7ed;
    }

    .priority-critical {
        background: #dc2626;
        color: #fef2f2;
    }

    .btn-icon {
        width: 2rem;
        height: 2rem;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        transition: all 0.15s ease;
    }

    .btn-icon:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .btn-icon-danger:hover {
        background: #7f1d1d;
        color: #fecaca;
    }

    .empty-state i {
        opacity: 0.3;
    }
</style>

@code {
    private List<Tasks>? tasks;
    private List<Tasks>? allTasks;
    private List<Employees> employees = new();
    private List<int> selectedEmployeeIds = new();
    private Dictionary<int, List<Employees>> taskAssignments = new();
    private string searchTerm = "";
    private string? errorMessage, successMessage;
    private bool showAddTaskForm = false;
    private bool showEditTaskForm = false;
    private int selectedTaskId;
    private bool isManager = false;
    private WorkStatus? statusFilter = null;

    private string FormatEnumName(string name) => System.Text.RegularExpressions.Regex.Replace(name, "(\\B[A-Z])", " $1");

    private IEnumerable<Tasks> FilteredTasks =>
        tasks?.Where(t =>
            string.IsNullOrEmpty(searchTerm) ||
            t.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            (t.Description?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
        ) ?? Enumerable.Empty<Tasks>();

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (authenticationState != null)
            {
                var authState = await authenticationState;
                var user = await UserManager.GetUserAsync(authState.User);
                if (user != null)
                {
                    isManager = await UserManager.IsInRoleAsync(user, "Manager")
                             || await UserManager.IsInRoleAsync(user, "Admin");
                }
            }

            allTasks = await TaskService.GetTasksAsync();
            tasks = allTasks;
            taskAssignments.Clear();

            if (tasks != null && tasks.Any())
            {
                foreach (var task in tasks)
                {
                    var assignments = await TaskService.GetTaskAssignmentsAsync(task.Id);
                    if (assignments?.Any() == true)
                    {
                        var employeeIds = assignments.Select(a => a.EmployeeId).ToList();
                        var assignedEmployees = (await EmployeeService.GetEmployeesAsync())
                            .Where(e => employeeIds.Contains(e.Id))
                            .ToList();

                        taskAssignments[task.Id] = assignedEmployees;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.WriteLine($"Error loading tasks: {ex.Message}");
        }
    }

    private string GetStatusClass(WorkStatus status) => status switch
    {
        WorkStatus.ToDo => "status-not-started",
        WorkStatus.InProgress => "status-in-progress",
        WorkStatus.Completed => "status-completed",
        WorkStatus.OnHold => "status-on-hold",
        WorkStatus.Cancelled => "status-cancelled",
        _ => "status-not-started"
    };

    private string GetPriorityClass(TaskPriority priority) => priority switch
    {
        TaskPriority.Low => "priority-low",
        TaskPriority.Medium => "priority-medium",
        TaskPriority.High => "priority-high",
        TaskPriority.Critical => "priority-critical",
        _ => "priority-medium"
    };

    private void SetStatusFilter(WorkStatus? status)
    {
        statusFilter = status;

        if (status == null)
        {
            tasks = allTasks;
        }
        else
        {
            tasks = allTasks?.Where(t => t.Status == status).ToList();
        }

        StateHasChanged();
    }

    private async Task DeleteTask(int taskId)
    {
        try
        {
            await TaskService.DeleteTaskAsync(taskId);
            await OnInitializedAsync();
            StateHasChanged();
            successMessage = "Task deleted successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.WriteLine($"Error deleting task: {ex.Message}");
        }
    }

    private void ToggleEmployee(int employeeId)
    {
        if (selectedEmployeeIds.Contains(employeeId))
            selectedEmployeeIds.Remove(employeeId);
        else
            selectedEmployeeIds.Add(employeeId);
    }

    private void ShowAddTaskForm()
    {
        showAddTaskForm = true;
        StateHasChanged();
    }

    private void ShowEditTaskForm(int taskId)
    {
        selectedTaskId = taskId;
        showEditTaskForm = true;
        StateHasChanged();
    }

    private async Task HandleAddFormClose()
    {
        showAddTaskForm = false;
        await OnInitializedAsync();
        StateHasChanged();
    }

    private async Task HandleEditFormClose()
    {
        showEditTaskForm = false;
        await OnInitializedAsync();
        StateHasChanged();
    }
}
